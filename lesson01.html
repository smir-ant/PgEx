<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PgEx 01</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/practice.css">
    <link rel="stylesheet" href="css/theory.css">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

</head>

<body>
    <a id="github" href="https://github.com/smir-ant/PgEx"><img src="assets/github.svg" alt=""></a>
    

    <main>
        <nav>
            <a id="proj_name" href="index.html">PgEx</a>
        </nav>

        <section id="sect_theory">
            <h1>–£—Ä–æ–∫ 1. –í—ã–±–æ—Ä–∫–∞: –∫–æ–ª–æ–Ω–∫–∏.</h1>
            <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Doloremque quisquam labore esse doloribus, a
                sed voluptatibus obcaecati voluptatem aperiam laborum excepturi voluptas maiores perferendis culpa
                quibusdam repellat cum ut. Dolorum aperiam aliquam inventore placeat repudiandae culpa delectus natus
                sapiente ratione cumque at dignissimos rerum, porro dolores adipisci suscipit vero maxime.</p>
            <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Doloremque quisquam labore esse doloribus, a
                sed voluptatibus obcaecati voluptatem aperiam laborum excepturi voluptas maiores perferendis culpa
                quibusdam repellat cum ut. Dolorum aperiam aliquam inventore placeat repudiandae culpa delectus natus
                sapiente ratione cumque at dignissimos rerum, porro dolores adipisci suscipit vero maxime.</p>
            <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Doloremque quisquam labore esse doloribus, a
                sed voluptatibus obcaecati voluptatem aperiam laborum excepturi voluptas maiores perferendis culpa
                quibusdam repellat cum ut. Dolorum aperiam aliquam inventore placeat repudiandae culpa delectus natus
                sapiente ratione cumque at dignissimos rerum, porro dolores adipisci suscipit vero maxime.</p>
        </section>

        <hr>
        <section id="schema">
            <!-- <figure class="schema_block">
                        
                <figcaption><label>–¢–∞–±–ª–∏—Ü–∞ <span id="tableName"></span></label></figcaption>
            </figure>
            <figure class="schema_block">
                        
                <figcaption><label>–¢–∞–±–ª–∏—Ü–∞ <span id="tableName"></span></label></figcaption>
            </figure> -->
        </section>

        <section id="sect_practice">
            

            <section id="group_table">    
                <div id="containerTable">
                    <table id="dataTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="status"></div>        
            </section>

            <section id="group_task">
                <div class="container">
                    <h3>–£—Ä–æ–∫ 1. &nbsp; –ó–∞–¥–∞–Ω–∏—è:</h3>
                    <ol>
                        <li>Find the <code>title</code> of each track</li>
                        <li class="disabled">Find the <code>artist</code> of each track</li>
                        <li class="disabled">Find the <code>title</code> and <code>artist</code> of each track</li>
                        <li class="disabled">Find the <code>title</code> and year of <code>release</code> of each track</li>
                        <li class="disabled">Find <code>all</code> the information about each track</li>
                    </ol>
                </div>
                <a class="btn disabled" href="lesson02.html" id="finishBtn">–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏—è –≤—ã—à–µ</a>
            </section>

            <section id="group_code" class="container"> 
                <!-- #sqlInput -->
                <textarea id="sqlInput" class="code"></textarea>
                    <!-- <div id="colored" class="code"></div>
                    <div id="sqlInput" class="code" contenteditable="true" spellcheck="false"></div> -->
            </section>  
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="scripts/highlightSQL.js"></script>

    <script src="scripts/isRightAns.js"></script>
    <script src="scripts/fillTableHtml.js"></script>
    <script src="scripts/status.js"></script>
    <script src="scripts/nextTask.js"></script>
    <script src="scripts/dbSchema.js" data-db="multi" type="module">// —Å–æ–∑–¥–∞—ë—Ç—Å—è createDB –∏–∑ –Ω—É–∂–Ω–æ–≥–æ scripts/db + –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ö–µ–º—ã</script> 
    
    <script type="module" > // –≤—ã–Ω—É–∂–¥–µ–Ω –æ—Å—Ç–∞–≤–ª—è—Ç—å js –≤ html, –∏–Ω–∞—á–µ cors –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑-–∑–∞ wasm, –∫–∞–∫ —è –ø–æ–Ω—è–ª  :(
        // createDB = [tablename, CREATE, INSERT]
        import { createDB } from './scripts/dbSchema.js';

        const answers = [
            `SELECT title FROM ${createDB[0][0]};`,
            `SELECT artist FROM ${createDB[0][0]};`,
            `SELECT title, artist FROM ${createDB[0][0]};`,
            `SELECT title, release FROM ${createDB[0][0]};`,
            `SELECT * FROM ${createDB[0][0]};`,
        ]
        console.log("tableName:", createDB[0][0]);
        

        const dataTable = document.getElementById('dataTable');
        const sqlInput = document.getElementById('sqlInput'); 
        // sqlInput.innerHTML = `SELECT * FROM ${tablename};`;
        let db = null;

        import { PGlite } from "https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/index.js";

        async function initializeDB() {            
            setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");
            
            db = new PGlite();
            // —Ç.–∫. —Ç—É—Ç –≤—Å—ë –∫–µ—à–∏—Ä—É–µ—Ç—Å—è, —Ç–æ —Å–ø–µ—Ä–≤–∞ —É–¥–∞–ª—è–µ–º –±–¥ –µ—Å–ª–∏ –±—ã–ª–∞
            // await db.query('DROP TABLE IF EXISTS ${tablename};');
            
            // —Å–æ–∑–¥–∞—ë–º –±–¥
            async function createTables(createDB) {
                for (const dbModel of createDB) {
                    console.log("----- –°–û–ó–î–ê–ú:", `CREATE TABLE ${dbModel[0]}` + dbModel[1])
                    await db.query(`CREATE TABLE ${dbModel[0]}` + dbModel[1]);

                }
            }
            createTables(createDB);
            
            // –Ω–∞–ø–æ–ª–Ω—è–µ–º –±–¥
            async function fillTables(createDB) {
                for (const dbModel of createDB) {
                    console.log("----- –í–°–¢–ê–í–õ–Æ:", `INSERT INTO ${dbModel[0]}` + dbModel[2])
                    await db.query(`INSERT INTO ${dbModel[0]}` + dbModel[2]);
                }
            }
            fillTables(createDB);

            /* // –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –∏–±–æ –Ω–∞–¥–æ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å + –≤ await
            // —Å–æ–∑–¥–∞—ë–º –±–¥
            // await db.query(`CREATE TABLE ${tablename}` + createDB[1]);
            // –Ω–∞–ø–æ–ª–Ω—è–µ–º –±–¥
            // await db.query(`INSERT INTO ${tablename}` + createDB[2]);
            */

            const firstQuery = `SELECT * FROM ${createDB[0][0]};`
            sqlInput.textContent = firstQuery;
            highlightEl();  // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π select * from —Ä–∞–∑—É–∫—Ä–∞—Å–∏—Ç—å

            // –∏–∑ –±–¥ –∑–∞–∫–∏–¥—ã–≤–∞–µ–º —ç—Ç–æ –≤ html
            const result = await db.query(firstQuery);
            fillTableHtml(result.rows, result.fields);  

            setStatus(`–ë–î –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${result.rows.length}`);

            //fetchTableData();
        }

        /*
        async function fetchTableData() {
            // ü§î‚ùì
            setStatus("–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...");
            const result = await db.query(`SELECT * FROM ${tablename};`);
            fillTableHtml(result.rows, result.fields);
            setStatus(`–ë–î –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${result.rows.length}`);
            
        }
        */


        let error_translate = {
            "syntax error at or near ": "—Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ–∑–ª–µ ",
            "argument of WHERE must be type boolean": "...",  // WHERE –ø–æ–¥–∞—ë—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ bool
            "operator does not exist: integer == inte": "...",  // –¥–≤–∞ —Ä–∞–≤–Ω–æ –≤ where
            "cannot insert multiple commands into a p": "...",  // –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥ —Å—Ä–∞–∑—É
        }

        
        // =============== –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∫–æ–º–∞–Ω–¥—ã ===============
        // –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é –Ω–µ –º–æ–≥—É –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ–º–µ–Ω–Ω–∞—è db —Å wasm –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
        async function executeSQL() {
            const sql = sqlInput.innerHTML.replaceAll('<div>', ' ')  // –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç—É—Ç —ç—Ç–æ div
                .replaceAll('</div>', '')
                .replaceAll('<br>', '')
                .replaceAll('&lt;', '<')
                .replaceAll('&gt;', '>')
                .replace(/(--.*$)/gm, '') // –£–¥–∞–ª—è–µ—Ç –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ sql
                .replace(/\/\*[\s\S]*?\*\//gm, '') // –£–¥–∞–ª—è–µ—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ sql
                // p.s. –ö–æ–≥–¥–∞ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —Å —Ñ–ª–∞–≥–æ–º g (–≥–ª–æ–±–∞–ª—å–Ω—ã–π), –º–µ—Ç–æ–¥ replace –∑–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–µ, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ –Ω–µ replaceAll
                .trim();
            if (!sql) {
                setStatus("–í–≤–µ–¥–∏ SQL –∑–∞–ø—Ä–æ—Å.");
                return;
            }
            setStatus(`–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å: ${sql}`);
            try {
                const isSelectQuery = sql.toLowerCase().startsWith("select");

                if (isSelectQuery) {
                    const result = await db.query(sql);
                    
                    fillTableHtml(result.rows, result.fields);
                    setStatus(`–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω. –í–µ—Ä–Ω—É—Ç–æ ${result.rows.length} —Å—Ç—Ä–æ–∫.`);
                    
                    // –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–ø—Ä–æ—Å, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –≤–µ—Ä–Ω—ã–π –ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ –∑–∞–¥–∞–Ω–∏—é
                    const taskAnswer = await db.query(answers[currentTask]);
                    if ( isRightAnswer(result['rows'], taskAnswer['rows']) ) {
                        nextTask();  // –Ω–∞ —Å–ª–µ–¥. –∑–∞–¥–∞—á—É
                    };
                } else {  // ----- DELETE, UPDATE..?‚ùóÔ∏è -----
                    //fetchTableData();
                    // ‚ùóÔ∏è
                    /* 
                    INSERT INTO ${tablename} (id, title, director, year, length_minutes) VALUES (16, 'Toy Story 4', 'El Directore', 2015, 90); 
                    */
                    const result = await db.exec(`
                        BEGIN;
                        ${sql}
                        -- –î–µ–ª–∞–µ–º SELECT –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                        SELECT * FROM ${tablename};

                        -- –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        ROLLBACK;
                    `);
                    // console.log("–ü–û–õ–£–ß–ò–õ–ò", result);
                    // console.log("–ü–û–õ–£–ß–ò–õ–ò2", result[2]);
                    
                    fillTableHtml(result[2].rows, result[2].fields);
                    setStatus(`–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω. –í–µ—Ä–Ω—É—Ç–æ ${result[2].rows.length} —Å—Ç—Ä–æ–∫.`)
                }
            } catch (error) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Object.keys –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–∞–º –æ–±—ä–µ–∫—Ç–∞
                //Object.keys(error_translate).forEach(phrase => {
                //    error.message = error.message.replace(phrase, error_translate[phrase]);
                //});
                //error_translate.forEach((phrase) => {error.message = error.message.replace(phrase, error_translate[phrase])})
                setStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        sqlInput.oninput = executeSQL;  // –ø—Ä–∏ –ª—é–±–æ–º –≤–≤–æ–¥–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—É
        window.onload = () => initializeDB();  // –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—Å—è –Ω–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    </script>
</body>

</html>